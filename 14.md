# 14

## Monitoring stack components

Prometheus Operator - tools for prometheus usage in k8s
Prometheus - monitoring system and time series database
Alertmanager - alerting system, handles alerts
Peometheus node exporter - collects metrics about k8s nodes
Prometheus Adapter for Kubernetes Metrics APIs - provides metrics API for k8s, such as CPU and memory usage
Grafana - visualization and analytics tool
kube-state-metrics - provides metrics about k8s objects

## Kube prometheus stack

I have installed kube prometheus stack with reccomendation from my colleague and friend @Markovnn. I have used this command:

```bash
minikube start --kubernetes-version=v1.23.0 --memory=6g --bootstrapper=kubeadm --extra-config=kubelet.authentication-token-webhook=true --extra-config=kubelet.authorization-mode=Webhook --extra-config=scheduler.bind-address=0.0.0.0 --extra-config=controller-manager.bind-address=0.0.0.0
```

Output of the `kubectl get po,sts,svc,pvc,cm` command
    
```bash
NAME                                                         READY   STATUS    RESTARTS      AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running   1 (28m ago)   29m
pod/app-python-0                                             1/1     Running   0             28m
pod/app-python-1                                             1/1     Running   0             28m
pod/app-python-2                                             1/1     Running   0             28m
pod/app-python-3                                             1/1     Running   0             28m
pod/app-python-4                                             1/1     Running   0             28m
pod/monitoring-grafana-69d8c6bb76-5rhbg                      3/3     Running   0             29m
pod/monitoring-kube-prometheus-operator-d6cfb6b6-kr74v       1/1     Running   0             29m
pod/monitoring-kube-state-metrics-57479f96d5-9hk2q           1/1     Running   0             29m
pod/monitoring-prometheus-node-exporter-mz7v7                1/1     Running   0             29m
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running   0             29m

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     29m
statefulset.apps/app-python                                             5/5     28m
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     29m

NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP      None             <none>        9093/TCP,9094/TCP,9094/UDP   29m
service/app-python                                ClusterIP      10.111.255.147   <none>        5000/TCP                     28m
service/kubernetes                                ClusterIP      10.96.0.1        <none>        443/TCP                      32m
service/monitoring-grafana                        LoadBalancer   10.109.48.215    <pending>     80:31707/TCP                 29m
service/monitoring-kube-prometheus-alertmanager   LoadBalancer   10.108.6.173     <pending>     9093:31284/TCP               29m
service/monitoring-kube-prometheus-operator       ClusterIP      10.102.229.129   <none>        443/TCP                      29m
service/monitoring-kube-prometheus-prometheus     ClusterIP      10.108.222.75    <none>        9090/TCP                     29m
service/monitoring-kube-state-metrics             ClusterIP      10.103.242.151   <none>        8080/TCP                     29m
service/monitoring-prometheus-node-exporter       ClusterIP      10.103.56.34     <none>        9100/TCP                     29m
service/prometheus-operated                       ClusterIP      None             <none>        9090/TCP                     29m

NAME                                                                     DATA   AGE
configmap/kube-root-ca.crt                                               1      32m
configmap/monitoring-grafana                                             1      29m
configmap/monitoring-grafana-config-dashboards                           1      29m
configmap/monitoring-kube-prometheus-alertmanager-overview               1      29m
configmap/monitoring-kube-prometheus-apiserver                           1      29m
configmap/monitoring-kube-prometheus-cluster-total                       1      29m
configmap/monitoring-kube-prometheus-controller-manager                  1      29m
configmap/monitoring-kube-prometheus-etcd                                1      29m
configmap/monitoring-kube-prometheus-grafana-datasource                  1      29m
configmap/monitoring-kube-prometheus-grafana-overview                    1      29m
configmap/monitoring-kube-prometheus-k8s-coredns                         1      29m
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      29m
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      29m
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      29m
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      29m
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      29m
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      29m
configmap/monitoring-kube-prometheus-kubelet                             1      29m
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      29m
configmap/monitoring-kube-prometheus-namespace-by-workload               1      29m
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      29m
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      29m
configmap/monitoring-kube-prometheus-nodes                               1      29m
configmap/monitoring-kube-prometheus-nodes-darwin                        1      29m
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      29m
configmap/monitoring-kube-prometheus-pod-total                           1      29m
configmap/monitoring-kube-prometheus-prometheus                          1      29m
configmap/monitoring-kube-prometheus-proxy                               1      29m
configmap/monitoring-kube-prometheus-scheduler                           1      29m
configmap/monitoring-kube-prometheus-workload-total                      1      29m
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   29     29m
```

Unfortunately, this did not help to gain access to all the metrics. So I will attach screenshots of the metrics that I have access to. Here it goes :)

![img](img/1.png)
Comparing CPU utiliastion of the pods and total CPU utilisation of the namespace

![img](img/2.png)
Pod and container count

![img](img/3.png)
Network usage and comparison

![img](img/4.png)
Statfulset resources

![img](img/5.png)
Node resources

![img](img/6.png)
Alertmanager

## Init container

```bash
kubectl exec -it init-demo -- cat /usr/share/nginx/html/index.html

Defaulted container "nginx" out of: nginx, install (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
```
